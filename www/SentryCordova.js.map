{"version":3,"file":"SentryCordova.js","sourceRoot":"","sources":["../src/js/SentryCordova.ts"],"names":[],"mappings":"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","sourcesContent":["import { ISentryBrowserOptions, SentryBrowser } from '@sentry/browser';\nimport { Client, Event, IAdapter, IBreadcrumb, IUser } from '@sentry/core';\n\ndeclare var window: any;\ndeclare var document: any;\n\nconst CORDOVA_DEVICE_RDY_TIMEOUT = 10000;\n\nexport interface ISentryBrowserConstructable<T> {\n  new (client: Client, options?: ISentryBrowserOptions): T;\n}\n\nexport interface ISentryCordovaOptions {\n  deviceReadyTimeout?: number;\n  sentryBrowser?: ISentryBrowserConstructable<SentryBrowser>;\n}\n\nexport class SentryCordova implements IAdapter {\n  private browser: SentryBrowser;\n  private client: Client;\n  private deviceReadyCallback: any;\n  private internalOptions: { [key: string]: string } = {};\n\n  private PLUGIN_NAME = 'Sentry';\n  private PATH_STRIP_RE = /^.*\\/[^\\.]+(\\.app|CodePush|.*(?=\\/))/;\n\n  constructor(client: Client, public options: ISentryCordovaOptions = {}) {\n    this.client = client;\n    if (!options.sentryBrowser) {\n      throw new Error(\n        'must pass SentryBrowser as an option { sentryBrowser: SentryBrowser }'\n      );\n    }\n    this.browser = new options.sentryBrowser(client);\n    return this;\n  }\n\n  public async install() {\n    this.browser.setOptions({\n      allowDuplicates: true,\n    });\n    await this.browser.install();\n    // This will prefix frames in raven with app://\n    // this is just a fallback if native is not available\n    this.setupNormalizeFrames();\n\n    return new Promise<boolean>((resolve, reject) => {\n      if (this.isCordova()) {\n        const timeout = this.options.deviceReadyTimeout || CORDOVA_DEVICE_RDY_TIMEOUT;\n        const deviceReadyTimeout = setTimeout(() => {\n          reject(`deviceready wasn't called for ${timeout} ms`);\n        }, timeout);\n        this.deviceReadyCallback = () =>\n          this.runInstall(resolve, reject, deviceReadyTimeout);\n        document.addEventListener('deviceready', this.deviceReadyCallback);\n      } else {\n        // We are in a browser\n        this.runInstall(resolve, reject);\n      }\n    })\n      .then(success => {\n        if (success && this.isCordova()) {\n          // We only want to register the breadcrumbcallback on success and running on\n          // Cordova otherwise we will get an endless loop\n          this.browser.setBreadcrumbCallback(crumb => this.captureBreadcrumb(crumb));\n        }\n        this.tryToSetSentryRelease();\n        return Promise.resolve(success);\n      })\n      .catch(reason => Promise.reject(reason));\n  }\n\n  public getBrowser(): any {\n    return this.browser as any;\n  }\n\n  public async setOptions(options: ISentryCordovaOptions) {\n    Object.assign(this.options, options);\n    return this;\n  }\n\n  public captureException(exception: Error) {\n    return this.browser.captureException(exception);\n  }\n\n  public captureMessage(message: string) {\n    return this.browser.captureMessage(message);\n  }\n\n  public captureBreadcrumb(crumb: IBreadcrumb) {\n    return this.nativeCall('captureBreadcrumb', crumb);\n  }\n\n  public send(event: Event) {\n    return this.nativeCall('send', event);\n  }\n\n  public async setUserContext(user?: IUser) {\n    await this.nativeCall('setUserContext', user);\n    return this;\n  }\n\n  public async setTagsContext(tags?: { [key: string]: any }) {\n    await this.nativeCall('setTagsContext', tags);\n    return this;\n  }\n\n  public async setExtraContext(extra?: { [key: string]: any }) {\n    await this.nativeCall('setExtraContext', extra);\n    return this;\n  }\n\n  public async clearContext() {\n    return this.nativeCall('clearContext');\n  }\n\n  public async setRelease(release: string) {\n    return this.setInternalOption('release', release);\n  }\n\n  public async setDist(dist: string) {\n    return this.setInternalOption('dist', dist);\n  }\n\n  public async setVersion(version: string) {\n    return this.setInternalOption('version', version);\n  }\n\n  // Private helpers\n\n  private setInternalOption(key: string, value: string) {\n    return this.setExtraContext({\n      [`__sentry_${key}`]: value,\n    });\n  }\n\n  private tryToSetSentryRelease() {\n    if (window.SENTRY_RELEASE !== undefined && window.SENTRY_RELEASE.id !== undefined) {\n      this.setRelease(window.SENTRY_RELEASE.id);\n      this.browser.getRaven().setRelease(window.SENTRY_RELEASE.id);\n      this.client.log('received release from window.SENTRY_RELEASE');\n    }\n  }\n\n  // ---------------------------------------\n\n  // CORDOVA --------------------\n  private isCordova() {\n    return window.cordova !== undefined || window.Cordova !== undefined;\n  }\n\n  private nativeCall(action: string, ...args: any[]): Promise<any> {\n    return new Promise((resolve, reject) => {\n      const exec = window && (window as any).Cordova && (window as any).Cordova.exec;\n      if (!exec) {\n        reject('Cordova.exec not available');\n      } else {\n        (window as any).Cordova.exec(resolve, reject, this.PLUGIN_NAME, action, args);\n      }\n    }).catch(e => {\n      if (e === 'not implemented' || e === 'Cordova.exec not available') {\n        // This is our fallback to the browser implementation\n        const browserCast = this.browser as any;\n        return browserCast[action](...args);\n      }\n      throw e;\n    });\n  }\n\n  private runInstall(\n    resolve: (value?: boolean | PromiseLike<boolean>) => void,\n    reject: (reason?: any) => void,\n    deviceReadyTimeout?: NodeJS.Timer\n  ) {\n    if (deviceReadyTimeout) {\n      document.removeEventListener('deviceready', this.deviceReadyCallback);\n      clearTimeout(deviceReadyTimeout);\n    }\n    this.nativeCall('install', this.client.dsn.getDsn(true), this.options)\n      .then(resolve)\n      .catch(reject);\n  }\n\n  // ----------------------------------------------------------\n  // Raven\n\n  private wrappedCallback(callback: any) {\n    function dataCallback(data: any, original: any) {\n      const normalizedData = callback(data) || data;\n      if (original) {\n        return original(normalizedData) || normalizedData;\n      }\n      return normalizedData;\n    }\n    return dataCallback;\n  }\n\n  private setupNormalizeFrames() {\n    const raven = this.browser.getRaven();\n    raven.setDataCallback(\n      this.wrappedCallback((data: any) => {\n        data = this.normalizeData(data);\n        // TODO\n        // if (internalDataCallback) {\n        //   internalDataCallback(data);\n        // }\n      })\n    );\n  }\n\n  private normalizeUrl(url: string, pathStripRe: RegExp) {\n    return 'app://' + url.replace(/^file\\:\\/\\//, '').replace(pathStripRe, '');\n  }\n\n  private normalizeData(data: any, pathStripRe?: RegExp) {\n    if (data.culprit) {\n      data.culprit = this.normalizeUrl(data.culprit, this.PATH_STRIP_RE);\n    }\n    // NOTE: if data.exception exists, exception.values and exception.values[0] are\n    // guaranteed to exist\n    const stacktrace =\n      data.stacktrace || (data.exception && data.exception.values[0].stacktrace);\n    if (stacktrace) {\n      stacktrace.frames.forEach((frame: any) => {\n        if (frame.filename !== '[native code]') {\n          frame.filename = this.normalizeUrl(frame.filename, this.PATH_STRIP_RE);\n        }\n      });\n    }\n    return data;\n  }\n\n  // -----------------------------------------------------------\n}\n"]}